<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 æ‰¹é‡å­—å¹•ä¸‹è¼‰åˆä½µå™¨ v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .log-box {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-box::-webkit-scrollbar { width: 8px; }
        .log-box::-webkit-scrollbar-track { background: #1f2937; }
        .log-box::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        /* å¢åŠ æ•™å­¸æ­¥é©Ÿçš„æ¨£å¼ */
        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-3xl rounded-xl shadow-xl overflow-hidden">
        <div class="bg-purple-700 p-6 text-white">
            <h1 class="text-2xl font-bold mb-2">ğŸ“‹ M3U8 æ‰¹é‡å­—å¹•ä¸‹è¼‰åˆä½µå™¨ v2.2</h1>
            <p class="text-purple-100 text-sm opacity-90">å°ˆæ²»å‹•æ…‹å¯†é‘°å½±ç‰‡ï¼Œä¸€æ¬¡æå®š 200+ å€‹ç‰‡æ®µ</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            
            <!-- æ•™å­¸å€å¡Š (å„ªåŒ–ç‰ˆ) -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-5 space-y-4">
                <h2 class="font-bold text-lg text-blue-900 flex items-center">
                    ğŸ” å…©æ­¥é©Ÿå–å¾—è³‡æ–™ (è«‹å…ˆæŒ‰ F12 é–‹å•Ÿé–‹ç™¼è€…å·¥å…·)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-700">
                    <!-- å·¦é‚Šï¼šæ‰¾æª”æ¡ˆ -->
                    <div class="space-y-2">
                        <p class="font-bold text-blue-700 border-b border-blue-200 pb-1">ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°é—œéµæª”æ¡ˆ</p>
                        <ul class="space-y-2">
                            <li class="flex items-start"><span class="step-badge">1</span>åˆ‡æ›åˆ° <strong>Network (ç¶²è·¯)</strong> åˆ†é ã€‚</li>
                            <li class="flex items-start"><span class="step-badge">2</span>åœ¨éæ¿¾æœå°‹æ¡†è¼¸å…¥ <code>m3u8</code>ã€‚</li>
                            <li class="flex items-start"><span class="step-badge">3</span>é‡æ–°æ•´ç†ç¶²é ï¼Œæˆ–æ‹‰å‹•å½±ç‰‡é€²åº¦æ¢ã€‚</li>
                            <li class="flex items-start"><span class="step-badge">4</span>æ‰¾åˆ°åç¨±é¡ä¼¼ <code>subtitles.m3u8</code> çš„æª”æ¡ˆã€‚</li>
                        </ul>
                    </div>

                    <!-- å³é‚Šï¼šäºŒé¸ä¸€ -->
                    <div class="space-y-2">
                        <p class="font-bold text-blue-700 border-b border-blue-200 pb-1">ç¬¬äºŒæ­¥ï¼šè¤‡è£½ (äºŒé¸ä¸€)</p>
                        
                        <div class="bg-white p-2 rounded border border-blue-100 shadow-sm">
                            <span class="text-xs font-bold text-purple-600 bg-purple-100 px-1 rounded">æ–¹æ³• A (ç°¡å–®)</span>
                            <p class="mt-1">å°è©²æª”æ¡ˆæŒ‰å³éµ -> Copy -> <strong>Copy link address (è¤‡è£½é€£çµç¶²å€)</strong>ï¼Œç„¶å¾Œè²¼åˆ°ä¸‹é¢ã€‚</p>
                        </div>

                        <div class="bg-white p-2 rounded border border-blue-100 shadow-sm">
                            <span class="text-xs font-bold text-green-600 bg-green-100 px-1 rounded">æ–¹æ³• B (æœ€ç©©)</span>
                            <p class="mt-1">é»æ“Šè©²æª”æ¡ˆï¼Œå³å´åˆ‡æ›åˆ° <strong>Preview (é è¦½)</strong> æˆ– <strong>Response</strong> åˆ†é ã€‚é»æ“Šå…§å®¹å€ï¼ŒæŒ‰ <strong>Ctrl+A å…¨é¸</strong>ä¸¦è¤‡è£½æ‰€æœ‰æ–‡å­—ï¼Œç„¶å¾Œè²¼åˆ°ä¸‹é¢ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¼¸å…¥å€ -->
            <div>
                <label class="block text-gray-700 font-bold mb-2 flex justify-between">
                    <span>è²¼ä¸Šå€åŸŸ</span>
                    <span class="text-xs font-normal text-gray-400 self-end">æ”¯æ´ï¼š.m3u8 ç¶²å€ æˆ– #EXTM3U å…§å®¹</span>
                </label>
                <textarea 
                    id="contentInput" 
                    rows="6"
                    placeholder="è«‹åœ¨æ­¤è²¼ä¸Š..."
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-xs font-mono bg-gray-50"
                ></textarea>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm text-gray-500" id="linkCountText">ç­‰å¾…è¼¸å…¥...</p>
                    <button onclick="clearInput()" class="text-xs text-red-500 hover:text-red-700 hover:underline">æ¸…ç©ºå…§å®¹</button>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <button 
                id="startBtn"
                onclick="processInputAndStart()" 
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed group"
            >
                <span class="group-hover:scale-110 transition-transform">ğŸš€</span>
                è§£æä¸¦é–‹å§‹ä¸‹è¼‰
            </button>

            <!-- é€²åº¦æ¢ -->
            <div id="progressContainer" class="hidden space-y-2">
                <div class="flex justify-between text-sm font-medium text-gray-600">
                    <span id="statusText">æº–å‚™ä¸­...</span>
                    <span id="counterText">0 / 0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-indigo-600 h-3 rounded-full w-0 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- è¨˜éŒ„å€ -->
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg h-48 overflow-y-auto text-xs log-box shadow-inner border border-gray-700" id="logBox">
                <span class="text-gray-500">ç³»çµ±æº–å‚™å°±ç·’ï¼Œç­‰å¾…ä½¿ç”¨è€…è¼¸å…¥...</span>
            </div>
        </div>
    </div>

    <script>
        const logBox = document.getElementById('logBox');
        const contentInput = document.getElementById('contentInput');
        const linkCountText = document.getElementById('linkCountText');
        const startBtn = document.getElementById('startBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const statusText = document.getElementById('statusText');
        const counterText = document.getElementById('counterText');

        // è¼¸å…¥æ¡†ç›£è½ï¼šç°¡å–®åˆ¤æ–·è¼¸å…¥çš„æ˜¯ç¶²å€é‚„æ˜¯å…§å®¹
        contentInput.addEventListener('input', () => {
            const text = contentInput.value.trim();
            if (text.length === 0) {
                linkCountText.innerText = 'ç­‰å¾…è¼¸å…¥...';
                return;
            }
            
            if (isM3U8Url(text)) {
                linkCountText.innerHTML = '<span class="text-blue-600 font-bold">ğŸ”— åµæ¸¬åˆ°ç¶²å€æ¨¡å¼</span> (é»æ“ŠæŒ‰éˆ•å¾Œç¨‹å¼å°‡è‡ªå‹•è§£æ)';
            } else {
                const urls = extractVttUrls(text);
                if (urls.length > 0) {
                    linkCountText.innerHTML = `<span class="text-purple-600 font-bold">ğŸ“„ åµæ¸¬åˆ°å…§å®¹æ¨¡å¼</span> (åŒ…å« ${urls.length} å€‹ç‰‡æ®µ)`;
                } else {
                    linkCountText.innerHTML = '<span class="text-red-500">âš ï¸ æ ¼å¼ä¼¼ä¹ä¸æ­£ç¢ºï¼Œæ‰¾ä¸åˆ° .vtt é€£çµ</span>';
                }
            }
        });

        function clearInput() {
            contentInput.value = '';
            linkCountText.innerText = 'ç­‰å¾…è¼¸å…¥...';
            contentInput.focus();
        }

        function isM3U8Url(text) {
            // ç°¡å–®æª¢æŸ¥ï¼šæ˜¯ http é–‹é ­ï¼Œä¸¦ä¸”åŒ…å« .m3u8ï¼Œä¸”ä¸åŒ…å«æ›è¡Œ (é¿å…èª¤åˆ¤å¤šè¡Œå…§å®¹)
            return /^https?:\/\/.+\.m3u8.*$/i.test(text) && !text.includes('\n');
        }

        function extractVttUrls(text) {
            // Regexï¼šæŠ“å– http é–‹é ­ä¸”åŒ…å« .vtt çš„é€£çµ
            const regex = /https?:\/\/[^\s"']+\.vtt[^\s"']*/g;
            return text.match(regex) || [];
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';
            if (type === 'warn') color = 'text-yellow-400';
            
            // æ¸…é™¤åˆå§‹æç¤º
            if(logBox.innerHTML.includes('ç³»çµ±æº–å‚™å°±ç·’')) logBox.innerHTML = '';
            
            logBox.innerHTML += `<div class="${color} mb-1 border-l-2 pl-2 ${type==='error'?'border-red-500':(type==='warn'?'border-yellow-500':'border-green-600')}"><span class="opacity-50 select-none">[${time}]</span> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processInputAndStart() {
            let text = contentInput.value.trim();
            if (!text) {
                alert("è«‹å…ˆè²¼ä¸Šç¶²å€æˆ–å…§å®¹ï¼");
                return;
            }

            // UI Reset
            logBox.innerHTML = '';
            startBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-green-500'); // Reset color

            // 1. åˆ¤æ–·è¼¸å…¥çš„æ˜¯ç¶²å€é‚„æ˜¯å…§å®¹
            if (isM3U8Url(text)) {
                log("ğŸ” åµæ¸¬åˆ° M3U8 ç¶²å€ï¼Œå˜—è©¦è«‹æ±‚å…§å®¹...");
                try {
                    const response = await fetch(text);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    text = await response.text();
                    log("âœ… æˆåŠŸå–å¾—æ¸…å–®å…§å®¹ï¼æ­£åœ¨è§£æ...");
                } catch (e) {
                    log(`âŒ ç„¡æ³•ç›´æ¥è®€å–ç¶²å€ (${e.message})`, 'error');
                    log(`ğŸ’¡ é€™æ˜¯ç€è¦½å™¨å®‰å…¨é™åˆ¶ (CORS)ã€‚è«‹æ”¹ç”¨ã€Œæ–¹æ³• Bã€ï¼š`, 'warn');
                    log(`1. è¤‡è£½è©²ç¶²å€ï¼Œåœ¨æ–°åˆ†é æ‰“é–‹`, 'warn');
                    log(`2. å…¨é¸ (Ctrl+A) ç•«é¢ä¸Šçš„æ–‡å­—ä¸¦è¤‡è£½`, 'warn');
                    log(`3. å›ä¾†é€™è£¡è²¼ä¸Š`, 'warn');
                    
                    if(confirm("ç„¡æ³•ç›´æ¥æŠ“å– (CORS é™åˆ¶)ã€‚\næ˜¯å¦è¦åœ¨æ–°è¦–çª—é–‹å•Ÿè©²ç¶²å€ï¼Ÿ\n\n(é–‹å•Ÿå¾Œè«‹è¤‡è£½æ‰€æœ‰å…§å®¹ï¼Œå†è²¼å›é€™è£¡)")) {
                        window.open(contentInput.value.trim(), '_blank');
                    }
                    
                    startBtn.disabled = false;
                    return;
                }
            }

            // 2. è§£æ VTT é€£çµ
            const urls = extractVttUrls(text);
            if (urls.length === 0) {
                log("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä»»ä½• .vtt é€£çµï¼", 'error');
                log("ğŸ’¡ è«‹ç¢ºèªä½ è²¼ä¸Šçš„æ˜¯æ­£ç¢ºçš„ subtitles.m3u8 å…§å®¹ã€‚", 'warn');
                alert("æ‰¾ä¸åˆ° .vtt é€£çµï¼\nè«‹ç¢ºèªå…§å®¹æ˜¯å¦æ­£ç¢ºã€‚");
                startBtn.disabled = false;
                return;
            }

            log(`ğŸš€ è§£ææˆåŠŸï¼å…±ç™¼ç¾ ${urls.length} å€‹å­—å¹•ç‰‡æ®µï¼Œé–‹å§‹ä¸‹è¼‰...`);
            await startBatchDownload(urls);
        }

        async function startBatchDownload(urls) {
            let finalContent = "";
            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                // æ›´æ–° UI
                statusText.innerText = `è™•ç†ä¸­... (${i + 1}/${urls.length})`;
                const percentage = Math.round(((i + 1) / urls.length) * 100);
                counterText.innerText = `${percentage}%`;
                progressBar.style.width = `${percentage}%`;

                try {
                    // éš¨æ©Ÿå»¶é² 50~150msï¼Œé¿å…éå¿«è¢«æ“‹
                    await new Promise(r => setTimeout(r, 50 + Math.random() * 100));

                    const content = await fetchSegment(url);
                    
                    if (content) {
                        if (i === 0) {
                            finalContent += content;
                        } else {
                            finalContent += cleanVttContent(content);
                        }
                        log(`âœ… [${i+1}] ä¸‹è¼‰æˆåŠŸ`);
                        successCount++;
                    } else {
                        log(`âŒ [${i+1}] ä¸‹è¼‰å¤±æ•— (404/403)`, 'error');
                        failCount++;
                    }
                } catch (e) {
                    log(`âŒ [${i+1}] éŒ¯èª¤: ${e.message}`, 'error');
                    failCount++;
                }
            }
            
            if (finalContent.length > 0) {
                downloadFile(finalContent, "full_course_subtitle_batch.vtt");
                log(`âœ¨ å…¨éƒ¨å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${failCount}`);
                statusText.innerText = "å®Œæˆï¼æª”æ¡ˆå·²ä¸‹è¼‰";
                progressBar.classList.add('bg-green-500'); // Success color
            } else {
                log("âŒ å…¨éƒ¨ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦éæœŸã€‚", 'error');
                statusText.innerText = "å¤±æ•—";
                progressBar.classList.add('bg-red-500');
            }

            startBtn.disabled = false;
        }

        async function fetchSegment(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                return await response.text();
            } catch (error) {
                return null;
            }
        }

        function cleanVttContent(rawText) {
            const lines = rawText.split('\n');
            let output = "";
            let headerPassed = false;
            for (let line of lines) {
                if (!headerPassed) {
                    if (line.includes('-->')) {
                        headerPassed = true;
                        output += "\n" + line + "\n"; 
                    }
                } else {
                    output += line + "\n";
                }
            }
            return output;
        }

        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/vtt;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>